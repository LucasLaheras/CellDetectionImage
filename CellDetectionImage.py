import cv2
import numpy as np
from psrGrayHistogram import psrGrayHistogram
from matplotlib import pyplot as plt
from lplFirefly import lplFirefly
from psrMultiLimiarizacao import psrMultiLimiarizacao


def CellDetectionImage(im0):
    # conversão pra tons de cinza
    im1 = cv2.cvtColor(im0, cv2.COLOR_BGR2GRAY)

    # equalização histogramica global
    im1 = lplHisteq(im1)

    # histograma
    H = psrGrayHistogram(im1)

    # gaus2
    # H = [0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0002, 0.0002, 0.0002, 0.0003, 0.0003, 0.0003, 0.0004, 0.0004, 0.0005, 0.0006, 0.0006, 0.0007, 0.0008, 0.0009, 0.0010, 0.0011, 0.0012, 0.0014, 0.0015, 0.0016, 0.0018, 0.0020, 0.0022, 0.0024, 0.0026, 0.0028, 0.0030, 0.0032, 0.0035, 0.0037, 0.0040, 0.0043, 0.0046, 0.0049, 0.0052, 0.0055, 0.0058, 0.0061, 0.0064, 0.0067, 0.0070, 0.0072, 0.0075, 0.0078, 0.0081, 0.0083, 0.0086, 0.0088, 0.0090, 0.0092, 0.0094, 0.0095, 0.0097, 0.0098, 0.0099, 0.0099, 0.0100, 0.0100, 0.0100, 0.0099, 0.0099, 0.0098, 0.0097, 0.0095, 0.0094, 0.0092, 0.0090, 0.0088, 0.0086, 0.0083, 0.0081, 0.0078, 0.0075, 0.0072, 0.0070, 0.0067, 0.0064, 0.0061, 0.0058, 0.0055, 0.0052, 0.0049, 0.0046, 0.0043, 0.0040, 0.0037, 0.0035, 0.0032, 0.0030, 0.0028, 0.0026, 0.0024, 0.0022, 0.0020, 0.0018, 0.0016, 0.0015, 0.0014, 0.0012, 0.0011, 0.0010, 0.0009, 0.0008, 0.0007, 0.0006, 0.0006, 0.0005, 0.0004, 0.0004, 0.0003, 0.0003, 0.0003, 0.0002, 0.0002, 0.0002, 0.0002, 0.0002, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0002, 0.0002, 0.0002, 0.0002, 0.0002, 0.0003, 0.0003, 0.0003, 0.0004, 0.0004, 0.0005, 0.0006, 0.0006, 0.0007, 0.0008, 0.0009, 0.0010, 0.0011, 0.0012, 0.0014, 0.0015, 0.0016, 0.0018, 0.0020, 0.0022, 0.0024, 0.0026, 0.0028, 0.0030, 0.0032, 0.0035, 0.0037, 0.0040, 0.0043, 0.0046, 0.0049, 0.0052, 0.0054, 0.0058, 0.0061, 0.0064, 0.0067, 0.0070, 0.0072, 0.0075, 0.0078, 0.0081, 0.0083, 0.0086, 0.0088, 0.0090, 0.0092, 0.0094, 0.0095, 0.0097, 0.0098, 0.0099, 0.0099, 0.0100, 0.0100, 0.0100, 0.0099, 0.0099, 0.0098, 0.0097, 0.0095, 0.0094, 0.0092, 0.0090, 0.0088, 0.0086, 0.0083, 0.0081, 0.0078, 0.0075, 0.0072, 0.0070, 0.0067, 0.0064, 0.0061, 0.0058, 0.0054, 0.0052, 0.0049, 0.0046, 0.0043, 0.0040, 0.0037, 0.0035, 0.0032, 0.0030, 0.0028, 0.0026, 0.0024, 0.0022, 0.0020, 0.0018, 0.0016, 0.0015, 0.0014, 0.0012, 0.0011, 0.0010, 0.0009, 0.0008, 0.0007, 0.0006, 0.0006, 0.0005, 0.0004, 0.0004, 0.0003, 0.0003, 0.0003, 0.0002, 0.0002, 0.0002, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001]

    # gaus3
    # H = [0.0008, 0.0009, 0.0010, 0.0011, 0.0012, 0.0013, 0.0015, 0.0016, 0.0017, 0.0019, 0.0020, 0.0022, 0.0024, 0.0025, 0.0027, 0.0058, 0.0060, 0.0061, 0.0063, 0.0064, 0.0065, 0.0066, 0.0066, 0.0067, 0.0067, 0.0068, 0.0068, 0.0068, 0.0067, 0.0067, 0.0066, 0.0066, 0.0065, 0.0064, 0.0063, 0.0061, 0.0060, 0.0058, 0.0057, 0.0055, 0.0053, 0.0051, 0.0049, 0.0047, 0.0045, 0.0044, 0.0042, 0.0040, 0.0038, 0.0036, 0.0034, 0.0032, 0.0030, 0.0028, 0.0027, 0.0025, 0.0024, 0.0022, 0.0021, 0.0020, 0.0019, 0.0018, 0.0017, 0.0016, 0.0016, 0.0015, 0.0015, 0.0015, 0.0015, 0.0015, 0.0015, 0.0015, 0.0016, 0.0016, 0.0017, 0.0018, 0.0019, 0.0020, 0.0021, 0.0022, 0.0023, 0.0025, 0.0026, 0.0028, 0.0030, 0.0031, 0.0033, 0.0035, 0.0037, 0.0039, 0.0041, 0.0043, 0.0045, 0.0047, 0.0048, 0.0050, 0.0052, 0.0054, 0.0056, 0.0057, 0.0059, 0.0060, 0.0061, 0.0063, 0.0064, 0.0064, 0.0065, 0.0066, 0.0066, 0.0066, 0.0067, 0.0066, 0.0066, 0.0066, 0.0065, 0.0064, 0.0064, 0.0063, 0.0061, 0.0060, 0.0059, 0.0057, 0.0056, 0.0054, 0.0052, 0.0050, 0.0048, 0.0047, 0.0045, 0.0043, 0.0041, 0.0039, 0.0037, 0.0035, 0.0033, 0.0031, 0.0030, 0.0028, 0.0026, 0.0025, 0.0023, 0.0022, 0.0021, 0.0020, 0.0019, 0.0018, 0.0017, 0.0016, 0.0016, 0.0015, 0.0015, 0.0015, 0.0015, 0.0015, 0.0015, 0.0015, 0.0016, 0.0016, 0.0017, 0.0018, 0.0019, 0.0020, 0.0021, 0.0022, 0.0024, 0.0025, 0.0027, 0.0028, 0.0030, 0.0032, 0.0033, 0.0035, 0.0037, 0.0039, 0.0041, 0.0043, 0.0045, 0.0047, 0.0049, 0.0051, 0.0053, 0.0054, 0.0056, 0.0058, 0.0059, 0.0061, 0.0062, 0.0063, 0.0064, 0.0065, 0.0066, 0.0066, 0.0067, 0.0067, 0.0067, 0.0067, 0.0067, 0.0066, 0.0066, 0.0065, 0.0064, 0.0063, 0.0062, 0.0061, 0.0059, 0.0058, 0.0056, 0.0054, 0.0053, 0.0051, 0.0049, 0.0047, 0.0045, 0.0043, 0.0041, 0.0039, 0.0037, 0.0035, 0.0033, 0.0031, 0.0029, 0.0027, 0.0025, 0.0023, 0.0022, 0.0020, 0.0019, 0.0017, 0.0016, 0.0015, 0.0013, 0.0012, 0.0011, 0.0010, 0.0009, 0.0008, 0.0007, 0.0007, 0.0006, 0.0005, 0.0005]

    # gaus4
    # H = [0.0001, 0.0001, 0.0001, 0.0002, 0.0003, 0.0003, 0.0004, 0.0006, 0.0007, 0.0009, 0.0011, 0.0014, 0.0016, 0.0020, 0.0024, 0.0028, 0.0032, 0.0037, 0.0043, 0.0049, 0.0055, 0.0061, 0.0067, 0.0072, 0.0078, 0.0083, 0.0088, 0.0092, 0.0095, 0.0098, 0.0099, 0.0100, 0.0099, 0.0098, 0.0095, 0.0092, 0.0088, 0.0083, 0.0078, 0.0072, 0.0067, 0.0061, 0.0055, 0.0049, 0.0043, 0.0037, 0.0032, 0.0028, 0.0024, 0.0020, 0.0016, 0.0014, 0.0011, 0.0009, 0.0007, 0.0006, 0.0004, 0.0003, 0.0003, 0.0002, 0.0002, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0002, 0.0002, 0.0003, 0.0003, 0.0004, 0.0006, 0.0007, 0.0009, 0.0011, 0.0014, 0.0016, 0.0020, 0.0024, 0.0028, 0.0032, 0.0037, 0.0043, 0.0049, 0.0054, 0.0060, 0.0067, 0.0072, 0.0078, 0.0083, 0.0088, 0.0092, 0.0095, 0.0098, 0.0099, 0.0100, 0.0099, 0.0098, 0.0095, 0.0092, 0.0088, 0.0083, 0.0078, 0.0072, 0.0067, 0.0060, 0.0054, 0.0049, 0.0043, 0.0037, 0.0032, 0.0028, 0.0024, 0.0020, 0.0016, 0.0014, 0.0011, 0.0009, 0.0007, 0.0006, 0.0004, 0.0003, 0.0003, 0.0002, 0.0002, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0002, 0.0002, 0.0003, 0.0003, 0.0004, 0.0006, 0.0007, 0.0009, 0.0011, 0.0014, 0.0016, 0.0020, 0.0024, 0.0028, 0.0032, 0.0037, 0.0043, 0.0049, 0.0054, 0.0060, 0.0067, 0.0072, 0.0078, 0.0083, 0.0088, 0.0092, 0.0095, 0.0098, 0.0099, 0.0100, 0.0099, 0.0098, 0.0095, 0.0092, 0.0088, 0.0083, 0.0078, 0.0072, 0.0067, 0.0060, 0.0054, 0.0049, 0.0043, 0.0037, 0.0032, 0.0028, 0.0024, 0.0020, 0.0016, 0.0014, 0.0011, 0.0009, 0.0007, 0.0006, 0.0004, 0.0003, 0.0003, 0.0002, 0.0002, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0002, 0.0002, 0.0003, 0.0003, 0.0004, 0.0006, 0.0007, 0.0009, 0.0011, 0.0014, 0.0016, 0.0020, 0.0024, 0.0028, 0.0032, 0.0037, 0.0043, 0.0049, 0.0054, 0.0061, 0.0067, 0.0072, 0.0078, 0.0083, 0.0088, 0.0092, 0.0095, 0.0098, 0.0099, 0.0100, 0.0099, 0.0098, 0.0095, 0.0092, 0.0088, 0.0083, 0.0078, 0.0072, 0.0067, 0.0061, 0.0054, 0.0049, 0.0043, 0.0037, 0.0032, 0.0028, 0.0024, 0.0020, 0.0016, 0.0014, 0.0011, 0.0009, 0.0007, 0.0006, 0.0004, 0.0003, 0.0003, 0.0002, 0.0001, 0.0001, 0.0001, 0.0001]

    # gaus5
    # H = [0.0005, 0.0006, 0.0007, 0.0009, 0.0011, 0.0013, 0.0016, 0.0019, 0.0022, 0.0026, 0.0030, 0.0035, 0.0039, 0.0044, 0.0049, 0.0054, 0.0058, 0.0063, 0.0067, 0.0071, 0.0074, 0.0077, 0.0079, 0.0080, 0.0080, 0.0080, 0.0079, 0.0077, 0.0074, 0.0071, 0.0067, 0.0063, 0.0058, 0.0054, 0.0049, 0.0044, 0.0039, 0.0035, 0.0030, 0.0026, 0.0023, 0.0019, 0.0016, 0.0014, 0.0012, 0.0010, 0.0009, 0.0008, 0.0007, 0.0007, 0.0007, 0.0008, 0.0009, 0.0010, 0.0012, 0.0014, 0.0016, 0.0019, 0.0022, 0.0026, 0.0030, 0.0034, 0.0039, 0.0044, 0.0048, 0.0053, 0.0058, 0.0062, 0.0067, 0.0070, 0.0074, 0.0076, 0.0078, 0.0079, 0.0080, 0.0079, 0.0078, 0.0076, 0.0074, 0.0070, 0.0067, 0.0062, 0.0058, 0.0053, 0.0048, 0.0044, 0.0039, 0.0034, 0.0030, 0.0026, 0.0022, 0.0019, 0.0016, 0.0014, 0.0012, 0.0010, 0.0009, 0.0008, 0.0007, 0.0007, 0.0007, 0.0008, 0.0009, 0.0010, 0.0012, 0.0014, 0.0016, 0.0019, 0.0022, 0.0026, 0.0030, 0.0034, 0.0039, 0.0044, 0.0048, 0.0053, 0.0058, 0.0062, 0.0067, 0.0070, 0.0074, 0.0076, 0.0078, 0.0079, 0.0080, 0.0079, 0.0078, 0.0076, 0.0074, 0.0070, 0.0067, 0.0062, 0.0058, 0.0053, 0.0048, 0.0044, 0.0039, 0.0034, 0.0030, 0.0026, 0.0022, 0.0019, 0.0016, 0.0014, 0.0012, 0.0010, 0.0009, 0.0008, 0.0007, 0.0007, 0.0007, 0.0008, 0.0009, 0.0010, 0.0012, 0.0014, 0.0016, 0.0019, 0.0022, 0.0026, 0.0030, 0.0034, 0.0039, 0.0044, 0.0048, 0.0053, 0.0058, 0.0062, 0.0067, 0.0070, 0.0074, 0.0076, 0.0078, 0.0079, 0.0080, 0.0079, 0.0078, 0.0076, 0.0074, 0.0070, 0.0067, 0.0062, 0.0058, 0.0053, 0.0048, 0.0044, 0.0039, 0.0034, 0.0030, 0.0026, 0.0022, 0.0019, 0.0016, 0.0014, 0.0012, 0.0010, 0.0009, 0.0008, 0.0007, 0.0007, 0.0007, 0.0008, 0.0009, 0.0010, 0.0012, 0.0014, 0.0016, 0.0019, 0.0022, 0.0026, 0.0030, 0.0034, 0.0039, 0.0044, 0.0048, 0.0053, 0.0058, 0.0063, 0.0067, 0.0070, 0.0074, 0.0076, 0.0078, 0.0079, 0.0080, 0.0079, 0.0078, 0.0076, 0.0074, 0.0070, 0.0067, 0.0063, 0.0058, 0.0053, 0.0048, 0.0044, 0.0039, 0.0034, 0.0030, 0.0026, 0.0022, 0.0019, 0.0016, 0.0013, 0.0011, 0.0009, 0.0007, 0.0006, 0.0004, 0.0004, 0.0003, 0.0002, 0.0002, 0.0001, 0.0001, 0.0001]

    # segmentação binaria com firefly
    bests = lplFirefly(50, 1, 1, 0.97, 1, 100, H)

    # multisegmentação
    im2 = psrMultiLimiarizacao(im1, bests)
    mostra(im2)


    # 3x dilatação binaria
    Lin, Col = im1.shape
    kernel = np.ones((Lin, Col), np.uint8)
    im2 = cv2.dilate(im1, kernel, 3)


    # obtem somente a maior região = região de interesse

    # separa somente a maior região de interesse

    # histograma na região de interesse

    # level-set somente na rtegião de interesse

    # normalização

    # colorização randomica das regiões de interesse

    return


def unique(image):
    unique = []

    for i in range(256):
        unique.append(0)

    lin, col = image.shape

    for y in range(lin):
        for x in range(col):
            unique[image[y][x]] = 1

    for i in range(256):
        if unique[i] > 0:
            print(i)

    return


def histograma(image):

    hist, bins = np.histogram(image.flatten(), 256, [0, 256])
    cdf = hist.cumsum()

    cdf_normalized = cdf * (hist.max() / cdf.max())
    plt.plot(cdf_normalized, 'b')
    plt.hist(image.flatten(), 256, [0, 256], 'r')
    plt.xlim([0, 256])
    plt.legend(('cdf', 'histogram'), 'upper left')
    plt.show()

    return


def mostra(img, name='Name'):
    cv2.namedWindow(name, cv2.WINDOW_NORMAL)
    cv2.imshow(name, img)
    cv2.waitKey(0)
    cv2.destroyAllWindows()
    return


def maxmax(image):
    print(max([valor for linha in image for valor in linha]))


def lplHisteq(im1):
    H = psrGrayHistogram(im1)

    for i in range(255):
        H[i+1] = H[i+1] + H[i]

    lin, col = im1.shape

    imeq = im1

    for y in range(lin):
        for x in range(col):
            imeq[y, x] = round(H[im1[y, x]]*255)

    return imeq
